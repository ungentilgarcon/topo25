# Dataset reference

This document describes the data model used by the application and how each component (methods, publications, UI) uses the data. It focuses on the main collections: Topograms, Nodes, and Edges. Auxiliary collections: Comments (unused by UI) and Meteor users.

## Collections and Schemas

### Topograms (`topograms`)
Source: `imports/api/topograms/Topograms.js`

Fields (SimpleSchema):
- title: String (required)
- slug: String (required) — URL-safe title
- sharedPublic: Boolean (default false) — if true, visible to anonymous users
- description: String (optional)
- userId: String (optional, Meteor user _id)
- createdAt: Date (required)

Notes:
- Denies client-side insert/update/remove; operations go through methods or JSON API.
- Helpers avoid server-side DB access (Meteor 3 compatibility); use publications to fetch author metadata.

Relationships:
- One Topogram has many Nodes and Edges where `topogramId` equals the Topogram’s `_id`.

Typical document example:
```
{
  _id: "t123",
  title: "Sample Topogram",
  slug: "sample-topogram",
  sharedPublic: true,
  description: "Autogenerated seed data for local testing.",
  userId: "u123",               // optional
  createdAt: ISODate("2025-10-05T10:00:00Z")
}
```

### Nodes (`nodes`)
Source: `imports/api/nodes/Nodes.js`

Fields (SimpleSchema):
- topogramId: String (required) — FK to Topograms._id
- data: Object (optional)
  - data.id: String (required on insert; autogenerates if omitted) — Cytoscape node id used by UI and edges
  - data.name: String (optional)
  - data.starred: Boolean (optional)
  - data.start: Date (optional)
  - data.end: Date (optional)
  - data.lat: Number (optional)
  - data.lng: Number (optional)
  - data.weight: Number (optional)
  - data.color: String (optional)
  - data.group: String (optional)
  - data.notes: String (optional, markdown)
- group: String (default "nodes") — collection group tag
- position: Object (optional)
  - position.x: Number (autoValue random if missing)
  - position.y: Number (autoValue random if missing)
- owner: String (optional, Meteor user _id)
- updatedAt: Date (autoValue now)
- createdAt: Date (autoValue on insert)

Notes:
- `data.id` is the stable identifier referenced by Edges `data.source`/`data.target` and by many methods.
- Node methods and reducers rely heavily on `data.*` fields for styling and charts.

Typical document example:
```
{
  _id: "nMongoId",
  topogramId: "t123",
  data: {
    id: "node-a",
    name: "Alpha",
    group: "person",
    color: "#4f46e5",
    weight: 3,
    notes: "markdown...",
    lat: 48.86,
    lng: 2.35
  },
  position: { x: 120, y: 80 },
  group: "nodes",
  createdAt: ISODate(...),
  updatedAt: ISODate(...)
}
```

### Edges (`edges`)
Source: `imports/api/edges/Edges.js`

Fields (SimpleSchema):
- topogramId: String (required) — FK to Topograms._id
- data: Object (optional)
  - data.id: String (optional; autogenerates if omitted)
  - data.source: String (required) — node `data.id` of source
  - data.target: String (required) — node `data.id` of target
  - data.name: String (optional)
  - data.starred: Boolean (optional)
  - data.start: Date (optional)
  - data.end: Date (optional)
  - data.weight: Number (optional)
  - data.color: String (optional)
  - data.group: String (optional)
  - data.notes: String (optional)
- group: String (default "edges")
- position: Object (optional) — reserved for future; not currently used by UI
- owner: String (optional, Meteor user _id)
- updatedAt: Date (autoValue now)
- createdAt: Date (autoValue on insert)

Notes:
- `data.source`/`data.target` must match existing Node `data.id` (not `_id`).

Typical document example:
```
{
  _id: "eMongoId",
  topogramId: "t123",
  data: {
    id: "edge-ab",
    source: "node-a",
    target: "node-b",
    name: "knows",
    weight: 2
  },
  group: "edges",
  createdAt: ISODate(...),
  updatedAt: ISODate(...)
}
```

### Comments (`comments`)
Source: `imports/api/collections.js`

- Basic `new Mongo.Collection('comments')`, no attached schema here.
- Not actively used in main UI flows in this fork.

### Users (`Meteor.users`)
- Managed by Meteor accounts; alias exposed as `Users` in `imports/api/collections.js`.
- Publications attach limited author info to Topograms lists.

## Creation, Update, Deletion APIs

### Validated Methods
- Nodes: `node.create`, `node.createMany`, `node.update`, `node.move`, `node.delete`, `node.deleteMany`, `node.deleteAll`, `mergeNodes`, `deleteNodeAndConnectedEdges`, `updateNodePosition`, `updateNodesPositions`, `lockNode`, `starNode`.
  - Source: `imports/api/nodes/nodesMethods.js`
  - Important conventions:
    - `nodeId` in updates/moves refers to `data.id` (Cytoscape id), not Mongo `_id`.
    - Bulk ops accept arrays of plain objects; validation primarily via attached schema.
- Edges: `edge.create`, `edge.createMany`, `edge.update`, `edge.delete`, `edge.deleteMany`, `edge.deleteAll`.
  - Source: `imports/api/edges/edgesMethods.js`
  - `edgeId` in updates/deletes refers to `data.id` for updates (selector uses `{'data.id': edgeId}`), but `_id` for deleteMany; be careful to pass the expected identifier per method.
- Topograms: `topogram.create`, `topogram.delete`, `topogram.update`, `topogram.updateTitle`, `topogram.togglePublic`.
  - Source: `imports/api/topograms/topogramsMethods.js`
  - Titles must be unique per `userId`.

### JSON API (HTTP)
Source: `imports/endpoints/api-jsonroutes.js` and `imports/endpoints/*.js`
- Exposes endpoints to create/list topograms, and CRUD nodes/edges.
- Uses async `findOneAsync`, `fetchAsync`, `insertAsync`, etc.
- Public listing filters: `sharedPublic: { $in: [true, 1] }`.

## Publications and Subscriptions

- `topograms.public` and `topograms.private` (by user) — compose Topogram docs and attach `author` on the wire.
  - Source: `imports/api/topograms/server/publications.js`
- Additional publications for nodes/edges likely exist under `imports/api/server/publications.js` (see startup import). These typically publish `Nodes.find({ topogramId })` and `Edges.find({ topogramId })` to hydrate the client.

## UI Consumption Patterns

- Cytoscape elements are built from collection docs; the UI expects arrays of `nodes` and `edges` with `data` fields containing `id`, `source`, `target`, etc.
  - Source: `imports/client/ui/components/network/Network.jsx`
  - It compares counts and updates (`currNodes.length !== nodes.length`, etc.), then sets elements: `elements.nodes = nodes`, `elements.edges = edges`.
- Charts aggregate `data.weight` for nodes and edges to compute stats (mean, stdev, percentiles).
  - Source: `imports/client/ui/components/charts/Charts.jsx`
- Geo views read node `data.lat`/`data.lng` to place markers; edges are drawn between node coordinates.
  - Sources: `imports/client/ui/components/geoMap/GeoNodes.jsx`, `GeoEdges.jsx`, `GeoMap.jsx`.
- Containers pull from Redux slices with `state.nodes.nodes` and `state.edges.edges`, fed by subscriptions and selectors.
  - Sources: `imports/client/ui/containers/*.jsx`, `imports/client/reducers/nodes.js`.

## Seeding and Local Testing

- The dev-only seed script inserts one Topogram with three Nodes (with `data.id` = `node-a`, `node-b`, `node-c`) and three Edges connecting them.
  - Source: `imports/startup/server/seed.js`
  - Runs only in development or with `METEOR_SEED=1`. Disable with `METEOR_SKIP_SEED=1`.

Seed schema overview (default):
- Topogram: `{ title: 'Sample Topogram', slug: 'sample-topogram', sharedPublic: true, description, createdAt }`
- Nodes (3): each `{ topogramId, data: { id, name, group, color, weight }, position: { x, y }, group: 'nodes', createdAt }`
- Edges (3): each `{ topogramId, data: { id, source, target, name, weight }, group: 'edges', createdAt }`

Variants (optional; propose to add via env flags):
- GEO variant: populate `data.lat/lng` and renderable paths
- TIME variant: populate `data.start/end` spans across nodes/edges
- LARGE variant: generate N nodes, M edges with balanced degree
 - TOUR variant: cities (Paris → Berlin → Prague → Vienna) with `lat/lng` and ordered route edges

Example (PowerShell) to run TOUR variant:

```powershell
$env:SEED_VARIANT = "tour"; meteor
```

## Key Conventions

- Use `data.id` for node identity across the app and in edges; Mongo `_id` is used for DB-level operations (deleteMany selectors).
- `topogramId` is a Mongo `_id` string linking nodes/edges to their topogram.
- Client-side direct writes are denied; always use methods or the JSON API.
- SimplSchema via a collection2-like shim validates and cleans on insert/update (`imports/startup/server/plugins/collection2-shim.js`).

## Indexes

Indexes are ensured on startup (`imports/startup/server/indexes.js`):
- Nodes: `{ topogramId: 1 }`, `{ 'data.id': 1 }`
- Edges: `{ topogramId: 1 }`, `{ 'data.id': 1 }`
- Topograms: `{ sharedPublic: 1, createdAt: -1 }`, `{ title: 1, userId: 1 }` (unique, sparse)

These cover typical queries used by publications and the JSON API.

See also: Dependency graph (docs/DEPENDENCY_GRAPH.md) for data and module relationships.
